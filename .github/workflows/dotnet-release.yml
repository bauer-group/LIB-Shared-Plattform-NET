# =============================================================================
# Release Workflow - LIB-Shared-Plattform-NET
# =============================================================================
# Complete CI/CD workflow for the shared platform libraries using reusable
# workflows from bauer-group/automation-templates:
# - PR validation (build & test)
# - Semantic versioning (conventional commits)
# - Automatic release creation
# - NuGet publishing to NuGet.org and GitHub Packages
# - Assembly signing with SNK key
#
# Uses conventional commits for automatic version bumping:
# - feat: -> minor version bump
# - fix: -> patch version bump
# - feat!: or BREAKING CHANGE: -> major version bump
#
# Required Secrets:
# - NUGET_API_KEY: API key for NuGet.org publishing
# - DOTNET_SIGNKEY_BASE64: Base64-encoded SNK key for assembly signing
# =============================================================================

name: ðŸš€ Release & Publish

on:
  push:
    branches: [main]
    paths-ignore:
      - ".github/**"
      - "*.md"
      - "docs/**"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "tests/**"
      - "*.sln"
      - "Directory.Build.props"
      - "Directory.Packages.props"
  workflow_dispatch:
    inputs:
      force-release:
        description: "Force create release (even without conventional commits)"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write
  issues: write
  pull-requests: write
  security-events: write

jobs:
  # ============================================
  # Validation (runs on all triggers)
  # ============================================
  validate:
    name: ðŸ”¨ Build & Test
    uses: bauer-group/automation-templates/.github/workflows/dotnet-build.yml@main
    with:
      project-path: "BAUERGROUP.Shared.Plattform.sln"
      dotnet-version: "10.0.x"
      run-tests: true
      collect-coverage: true
      # Windows runner for tests (Windows-specific tests need Windows)
      runs-on: "windows-latest"
      # SNK path must match AssemblyOriginatorKeyFile in Directory.Build.props
      snk-file-path: "build/BAUERGROUP.Shared.snk"
    secrets: inherit

  # ============================================
  # Semantic Release (only on main branch push)
  # ============================================
  release:
    name: ðŸ“¦ Create Release
    needs: validate
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'
    uses: bauer-group/automation-templates/.github/workflows/modules-semantic-release.yml@main
    with:
      target-branch: "main"
      force-release: ${{ inputs.force-release || false }}
      extra-plugins: "semantic-release-dotnet"
    secrets: inherit

  # ============================================
  # Publish NuGet Packages (after release)
  # ============================================
  publish:
    name: ðŸ“¤ Publish to NuGet & GitHub
    needs: release
    if: needs.release.outputs.release-created == 'true'
    uses: bauer-group/automation-templates/.github/workflows/dotnet-publish-library.yml@main
    with:
      project-path: "BAUERGROUP.Shared.Plattform.sln"
      dotnet-version: "10.0.x"

      # Version from semantic-release
      release-version: ${{ needs.release.outputs.version }}

      # Build on Linux (default) - Windows TFMs work via EnableWindowsTargeting
      # runs-on: "ubuntu-latest" (default)

      # Tests already ran in validate job
      run-tests: false

      # Assembly signing
      sign-assembly: true

      # Publishing
      push-to-nuget: true
      push-to-github: true
      nuget-auth-method: "api-key"

      # Package options
      include-symbols: true
      include-source: true
      deterministic-build: true
    secrets: inherit

  # ============================================
  # PR Package Validation (only on pull requests)
  # ============================================
  pr-validate:
    name: ðŸ“‹ Validate Package (PR)
    needs: validate
    if: github.event_name == 'pull_request'
    uses: bauer-group/automation-templates/.github/workflows/dotnet-publish-library.yml@main
    with:
      project-path: "BAUERGROUP.Shared.Plattform.sln"
      dotnet-version: "10.0.x"

      # Preview version for PR
      version-suffix: "pr"

      # Build on Linux (default)
      # runs-on: "ubuntu-latest" (default)

      # Tests already ran in validate job
      run-tests: false

      # Build and validate package
      create-package: true
      include-symbols: true

      # Don't publish
      push-to-nuget: false
      push-to-github: false
    secrets: inherit
